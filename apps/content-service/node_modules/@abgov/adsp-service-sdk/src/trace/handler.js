"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.createTraceHandler = exports.traceRequestInterceptor = void 0;
const axios_1 = require("axios");
const context = require("express-http-context");
const TraceParent = require("traceparent");
const context_1 = require("./context");
function traceRequestInterceptor(config) {
    var _a, _b;
    const trace = (0, context_1.getContextTrace)();
    if (trace && !((_a = config.headers) === null || _a === void 0 ? void 0 : _a.has(context_1.TRACE_PARENT_HEADER))) {
        (_b = config.headers) === null || _b === void 0 ? void 0 : _b.set(context_1.TRACE_PARENT_HEADER, trace.toString());
    }
    return config;
}
exports.traceRequestInterceptor = traceRequestInterceptor;
function createTraceHandler({ logger, sampleRate }) {
    // Use an axios interceptor to add the traceparent header if not already present.
    axios_1.default.interceptors.request.use(traceRequestInterceptor);
    return function (req, res, next) {
        context.middleware(req, res, (err) => {
            var _a;
            if (!err) {
                try {
                    const trace = TraceParent.startOrResume(req.headers[context_1.TRACE_PARENT_HEADER], {
                        transactionSampleRate: sampleRate,
                    });
                    context.set(context_1.TRACE_PARENT_CTX, trace);
                    // Debug log non-root endpoint requests.
                    if (((_a = req.originalUrl) === null || _a === void 0 ? void 0 : _a.length) > 1) {
                        logger.debug(`${req.method}: ${req.originalUrl} from ${req.ip}`);
                    }
                }
                catch (traceErr) {
                    err = traceErr;
                }
            }
            next(err);
        });
    };
}
exports.createTraceHandler = createTraceHandler;
//# sourceMappingURL=handler.js.map