"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.AssertCoreRole = exports.AssertRole = exports.isAllowedUser = exports.hasRequiredRole = exports.UnauthorizedUserError = void 0;
const utils_1 = require("../utils");
const HttpStatusCodes = require("http-status-codes");
class UnauthorizedUserError extends utils_1.GoAError {
    constructor(operation, user, extra) {
        super(`User ${user === null || user === void 0 ? void 0 : user.name} (ID: ${user === null || user === void 0 ? void 0 : user.id}) not permitted to ${operation}.`, Object.assign({ statusCode: HttpStatusCodes.FORBIDDEN }, extra));
        Object.setPrototypeOf(this, UnauthorizedUserError.prototype);
    }
}
exports.UnauthorizedUserError = UnauthorizedUserError;
function hasRequiredRole(user, roles) {
    if (!(roles instanceof Array)) {
        roles = [roles];
    }
    const userRoles = (user === null || user === void 0 ? void 0 : user.roles) || [];
    // If user has at least one of the roles, then they are permitted.
    const matchedRole = roles.find((required) => userRoles.includes(required));
    return !!matchedRole;
}
exports.hasRequiredRole = hasRequiredRole;
function isAllowedUser(user, tenantId, roles, allowCore = false) {
    const isAllowedTenant = (allowCore && (user === null || user === void 0 ? void 0 : user.isCore)) ||
        (!!(user === null || user === void 0 ? void 0 : user.tenantId) && (!tenantId || tenantId.toString() === user.tenantId.toString()));
    return isAllowedTenant && hasRequiredRole(user, roles);
}
exports.isAllowedUser = isAllowedUser;
const AssertRole = (operation, constRoles, roleProperties = [], allowCore = false) => (_target, _propertyKey, descriptor) => {
    const method = descriptor.value;
    descriptor.value = function (...args) {
        const [user] = args;
        const roles = constRoles instanceof Array ? [...constRoles] : constRoles ? [constRoles] : [];
        if (roleProperties) {
            const properties = roleProperties instanceof Array ? [...roleProperties] : [roleProperties];
            const propertyRoles = properties.reduce((values, property) => [...values, ...(this[property] || [])], []);
            roles.push(...propertyRoles);
        }
        // If we don't allow core user or user is not a core user, AND
        // User has no tenant ID or tenant context on this exists and doesn't match user tenant, THEN
        // user is not authorized.
        if (!isAllowedUser(user, this.tenantId, roles, allowCore)) {
            throw new UnauthorizedUserError(operation, user);
        }
        return method.apply(this, args);
        // eslint-disable-next-line @typescript-eslint/no-explicit-any
    };
    return descriptor;
};
exports.AssertRole = AssertRole;
const AssertCoreRole = (operation, roles) => (_target, _propertyKey, descriptor) => {
    const method = descriptor.value;
    descriptor.value = function (...args) {
        const [user] = args;
        if (!(user === null || user === void 0 ? void 0 : user.isCore) || !hasRequiredRole(user, roles)) {
            throw new UnauthorizedUserError(operation, user);
        }
        return method.apply(this, args);
        // eslint-disable-next-line @typescript-eslint/no-explicit-any
    };
    return descriptor;
};
exports.AssertCoreRole = AssertCoreRole;
//# sourceMappingURL=assert.js.map