"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.LimitToOne = void 0;
const tslib_1 = require("tslib");
const results = new WeakMap();
/**
 * Method decorator that limits a method to a single active execution per key.
 * The same promise chain is used to respond to callers until it is fulfilled.
 *
 * @param {*} [getKey=(propertyKey) => propertyKey]
 * Function to get the key used to determine which executions share an execution;
 * method name is used if no function is provided. Return a falsy value to force execution.
 */
const LimitToOne = (getKey = (propertyKey) => propertyKey) => (_target, propertyKey, descriptor) => {
    const original = descriptor.value;
    // This is an async function, and callers will end up with a chained promise rather than the 'cached' one.
    descriptor.value = function (...args) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            let promises = results.get(this);
            if (!promises) {
                promises = {};
                results.set(this, promises);
            }
            const key = getKey(propertyKey, ...args);
            if (!key) {
                return yield original.apply(this, args);
            }
            else {
                let promise = promises[key];
                if (!promise) {
                    promise = original.apply(this, args);
                    promises[key] = promise;
                }
                try {
                    return yield promise;
                }
                finally {
                    promises[key] = null;
                }
            }
        });
    };
    return descriptor;
};
exports.LimitToOne = LimitToOne;
//# sourceMappingURL=limitToOne.js.map