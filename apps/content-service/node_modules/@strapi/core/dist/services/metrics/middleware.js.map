{"version":3,"file":"middleware.js","sources":["../../../src/services/metrics/middleware.ts"],"sourcesContent":["import type { Core } from '@strapi/types';\nimport type { Sender } from './sender';\n\ninterface State {\n  expires: number;\n  counter: number;\n}\n\nfunction nextResetDate(): number {\n  return Date.now() + 24 * 60 * 60 * 1000; // Now + 24 hours.\n}\n\nconst createMiddleware = ({ sendEvent, strapi }: { sendEvent: Sender; strapi: Core.Strapi }) => {\n  const state: State = {\n    expires: nextResetDate(),\n    counter: 0,\n  };\n\n  const middleware: Core.MiddlewareHandler = async (ctx, next) => {\n    const { url, method } = ctx.request;\n\n    if (\n      !url.includes('.') &&\n      url.includes(strapi.config.get('api.rest.prefix')) &&\n      ['GET', 'PUT', 'POST', 'DELETE'].includes(method)\n    ) {\n      if (Date.now() > state.expires) {\n        state.expires = nextResetDate();\n        state.counter = 0;\n      }\n\n      // Send max. 1000 events per day.\n      if (state.counter < 1000) {\n        sendEvent('didReceiveRequest', { eventProperties: { url: ctx.request.url } });\n\n        // Increase counter.\n        state.counter += 1;\n      }\n    }\n\n    await next();\n  };\n\n  return middleware;\n};\n\nexport default createMiddleware;\n"],"names":["nextResetDate","Date","now","createMiddleware","sendEvent","strapi","state","expires","counter","middleware","ctx","next","url","method","request","includes","config","get","eventProperties"],"mappings":";;AAQA,SAASA,aAAAA,GAAAA;AACP,IAAA,OAAOC,KAAKC,GAAG,EAAA,GAAK,KAAK,EAAK,GAAA,EAAA,GAAK;AACrC;AAEA,MAAMC,mBAAmB,CAAC,EAAEC,SAAS,EAAEC,MAAM,EAA8C,GAAA;AACzF,IAAA,MAAMC,KAAe,GAAA;QACnBC,OAASP,EAAAA,aAAAA,EAAAA;QACTQ,OAAS,EAAA;AACX,KAAA;IAEA,MAAMC,UAAAA,GAAqC,OAAOC,GAAKC,EAAAA,IAAAA,GAAAA;AACrD,QAAA,MAAM,EAAEC,GAAG,EAAEC,MAAM,EAAE,GAAGH,IAAII,OAAO;AAEnC,QAAA,IACE,CAACF,GAAAA,CAAIG,QAAQ,CAAC,GACdH,CAAAA,IAAAA,GAAAA,CAAIG,QAAQ,CAACV,MAAOW,CAAAA,MAAM,CAACC,GAAG,CAAC,iBAC/B,CAAA,CAAA,IAAA;AAAC,YAAA,KAAA;AAAO,YAAA,KAAA;AAAO,YAAA,MAAA;AAAQ,YAAA;SAAS,CAACF,QAAQ,CAACF,MAC1C,CAAA,EAAA;AACA,YAAA,IAAIZ,IAAKC,CAAAA,GAAG,EAAKI,GAAAA,KAAAA,CAAMC,OAAO,EAAE;AAC9BD,gBAAAA,KAAAA,CAAMC,OAAO,GAAGP,aAAAA,EAAAA;AAChBM,gBAAAA,KAAAA,CAAME,OAAO,GAAG,CAAA;AAClB;;YAGA,IAAIF,KAAAA,CAAME,OAAO,GAAG,IAAM,EAAA;AACxBJ,gBAAAA,SAAAA,CAAU,mBAAqB,EAAA;oBAAEc,eAAiB,EAAA;wBAAEN,GAAKF,EAAAA,GAAAA,CAAII,OAAO,CAACF;AAAI;AAAE,iBAAA,CAAA;;AAG3EN,gBAAAA,KAAAA,CAAME,OAAO,IAAI,CAAA;AACnB;AACF;QAEA,MAAMG,IAAAA,EAAAA;AACR,KAAA;IAEA,OAAOF,UAAAA;AACT;;;;"}