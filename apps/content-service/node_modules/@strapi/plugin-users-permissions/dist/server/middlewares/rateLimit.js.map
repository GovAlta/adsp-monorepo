{"version":3,"file":"rateLimit.js","sources":["../../../server/middlewares/rateLimit.js"],"sourcesContent":["'use strict';\n\nconst path = require('path');\nconst utils = require('@strapi/utils');\nconst { isString, has, toLower } = require('lodash/fp');\n\nconst { RateLimitError } = utils.errors;\n\nmodule.exports =\n  (config, { strapi }) =>\n  async (ctx, next) => {\n    let rateLimitConfig = strapi.config.get('plugin::users-permissions.ratelimit');\n\n    if (!rateLimitConfig) {\n      rateLimitConfig = {\n        enabled: true,\n      };\n    }\n\n    if (!has('enabled', rateLimitConfig)) {\n      rateLimitConfig.enabled = true;\n    }\n\n    if (rateLimitConfig.enabled === true) {\n      const rateLimit = require('koa2-ratelimit').RateLimit;\n\n      const userIdentifier = toLower(ctx.request.body.email) || 'unknownIdentifier';\n      const requestPath = isString(ctx.request.path)\n        ? toLower(path.normalize(ctx.request.path))\n        : 'invalidPath';\n\n      const loadConfig = {\n        interval: { min: 5 },\n        max: 5,\n        prefixKey: `${userIdentifier}:${requestPath}:${ctx.request.ip}`,\n        handler() {\n          throw new RateLimitError();\n        },\n        ...rateLimitConfig,\n        ...config,\n      };\n\n      return rateLimit.middleware(loadConfig)(ctx, next);\n    }\n\n    return next();\n  };\n"],"names":["path","require$$0","utils","require$$1","isString","has","toLower","require$$2","RateLimitError","errors","rateLimit","config","strapi","ctx","next","rateLimitConfig","get","enabled","require$$3","RateLimit","userIdentifier","request","body","email","requestPath","normalize","loadConfig","interval","min","max","prefixKey","ip","handler","middleware"],"mappings":";;;;;;;;;;;;AAEA,IAAA,MAAMA,IAAOC,GAAAA,UAAAA;AACb,IAAA,MAAMC,KAAQC,GAAAA,YAAAA;AACd,IAAA,MAAM,EAAEC,QAAQ,EAAEC,GAAG,EAAEC,OAAO,EAAE,GAAGC,UAAAA;AAEnC,IAAA,MAAM,EAAEC,cAAc,EAAE,GAAGN,MAAMO,MAAM;AAEzBC,IAAAA,SAAAA,GACZ,CAACC,MAAQ,EAAA,EAAEC,MAAM,EAAE,GACnB,OAAOC,GAAKC,EAAAA,IAAAA,GAAAA;AACV,YAAA,IAAIC,eAAkBH,GAAAA,MAAAA,CAAOD,MAAM,CAACK,GAAG,CAAC,qCAAA,CAAA;AAExC,YAAA,IAAI,CAACD,eAAiB,EAAA;gBACpBA,eAAkB,GAAA;oBAChBE,OAAS,EAAA;AACjB,iBAAA;AACK;YAED,IAAI,CAACZ,GAAI,CAAA,SAAA,EAAWU,eAAkB,CAAA,EAAA;AACpCA,gBAAAA,eAAAA,CAAgBE,OAAO,GAAG,IAAA;AAC3B;YAED,IAAIF,eAAAA,CAAgBE,OAAO,KAAK,IAAM,EAAA;gBACpC,MAAMP,SAAAA,GAAYQ,WAA0BC,SAAS;gBAErD,MAAMC,cAAAA,GAAiBd,QAAQO,GAAIQ,CAAAA,OAAO,CAACC,IAAI,CAACC,KAAK,CAAK,IAAA,mBAAA;AAC1D,gBAAA,MAAMC,WAAcpB,GAAAA,QAAAA,CAASS,GAAIQ,CAAAA,OAAO,CAACrB,IAAI,CAAA,GACzCM,OAAQN,CAAAA,IAAAA,CAAKyB,SAAS,CAACZ,GAAAA,CAAIQ,OAAO,CAACrB,IAAI,CACvC,CAAA,GAAA,aAAA;AAEJ,gBAAA,MAAM0B,UAAa,GAAA;oBACjBC,QAAU,EAAA;wBAAEC,GAAK,EAAA;AAAG,qBAAA;oBACpBC,GAAK,EAAA,CAAA;AACLC,oBAAAA,SAAAA,EAAW,CAAC,EAAEV,cAAe,CAAA,CAAC,EAAEI,WAAAA,CAAY,CAAC,EAAEX,GAAIQ,CAAAA,OAAO,CAACU,EAAE,CAAC,CAAC;AAC/DC,oBAAAA,OAAAA,CAAAA,GAAAA;AACE,wBAAA,MAAM,IAAIxB,cAAAA,EAAAA;AACX,qBAAA;AACD,oBAAA,GAAGO,eAAe;AAClB,oBAAA,GAAGJ;AACX,iBAAA;AAEM,gBAAA,OAAOD,SAAUuB,CAAAA,UAAU,CAACP,UAAAA,CAAAA,CAAYb,GAAKC,EAAAA,IAAAA,CAAAA;AAC9C;YAED,OAAOA,IAAAA,EAAAA;AACR,SAAA;;;;;;"}