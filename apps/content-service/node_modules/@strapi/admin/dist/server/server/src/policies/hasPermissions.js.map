{"version":3,"file":"hasPermissions.js","sources":["../../../../../server/src/policies/hasPermissions.ts"],"sourcesContent":["import _ from 'lodash';\nimport { policy } from '@strapi/utils';\nimport { validateHasPermissionsInput } from '../validation/policies/hasPermissions';\n\nconst { createPolicy } = policy;\n\nconst inputModifiers = [\n  {\n    check: _.isString,\n    transform: (action: any) => ({ action }),\n  },\n  {\n    check: _.isArray,\n    transform: (arr: any) => ({ action: arr[0], subject: arr[1] }),\n  },\n  {\n    // Has to be after the isArray check since _.isObject also matches arrays\n    check: _.isObject,\n    transform: (perm: any) => perm,\n  },\n];\n\nexport default createPolicy({\n  name: 'admin::hasPermissions',\n  validator: validateHasPermissionsInput,\n  handler(ctx, config) {\n    const { actions } = config;\n    const { userAbility: ability } = ctx.state;\n\n    const permissions = actions.map((action: any) =>\n      inputModifiers.find((modifier) => modifier.check(action))?.transform(action)\n    );\n\n    const isAuthorized = permissions.every(({ action, subject }: any) =>\n      ability.can(action, subject)\n    );\n\n    return isAuthorized;\n  },\n});\n"],"names":["createPolicy","policy","inputModifiers","check","_","isString","transform","action","isArray","arr","subject","isObject","perm","name","validator","validateHasPermissionsInput","handler","ctx","config","actions","userAbility","ability","state","permissions","map","find","modifier","isAuthorized","every","can"],"mappings":";;;;;;AAIA,MAAM,EAAEA,YAAY,EAAE,GAAGC,YAAAA;AAEzB,MAAMC,cAAiB,GAAA;AACrB,IAAA;AACEC,QAAAA,KAAAA,EAAOC,EAAEC,QAAQ;QACjBC,SAAW,EAAA,CAACC,UAAiB;AAAEA,gBAAAA;aAAO;AACxC,KAAA;AACA,IAAA;AACEJ,QAAAA,KAAAA,EAAOC,EAAEI,OAAO;QAChBF,SAAW,EAAA,CAACG,OAAc;gBAAEF,MAAQE,EAAAA,GAAG,CAAC,CAAE,CAAA;gBAAEC,OAASD,EAAAA,GAAG,CAAC,CAAE;aAAC;AAC9D,KAAA;AACA,IAAA;;AAEEN,QAAAA,KAAAA,EAAOC,EAAEO,QAAQ;AACjBL,QAAAA,SAAAA,EAAW,CAACM,IAAcA,GAAAA;AAC5B;AACD,CAAA;AAED,qBAAeZ,YAAa,CAAA;IAC1Ba,IAAM,EAAA,uBAAA;IACNC,SAAWC,EAAAA,4CAAAA;IACXC,OAAQC,CAAAA,CAAAA,GAAG,EAAEC,MAAM,EAAA;QACjB,MAAM,EAAEC,OAAO,EAAE,GAAGD,MAAAA;AACpB,QAAA,MAAM,EAAEE,WAAaC,EAAAA,OAAO,EAAE,GAAGJ,IAAIK,KAAK;AAE1C,QAAA,MAAMC,WAAcJ,GAAAA,OAAAA,CAAQK,GAAG,CAAC,CAACjB,MAC/BL,GAAAA,cAAAA,CAAeuB,IAAI,CAAC,CAACC,QAAaA,GAAAA,QAAAA,CAASvB,KAAK,CAACI,UAAUD,SAAUC,CAAAA,MAAAA,CAAAA,CAAAA;AAGvE,QAAA,MAAMoB,YAAeJ,GAAAA,WAAAA,CAAYK,KAAK,CAAC,CAAC,EAAErB,MAAM,EAAEG,OAAO,EAAO,GAC9DW,OAAQQ,CAAAA,GAAG,CAACtB,MAAQG,EAAAA,OAAAA,CAAAA,CAAAA;QAGtB,OAAOiB,YAAAA;AACT;AACF,CAAG,CAAA;;;;"}