name: Promote Apps

on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
    inputs:
      APPS:
        description: APPS to promote.
        required: true

jobs:
  testRegression:
    runs-on: ubuntu-20.04
    environment:
      name: Test-e2e
    strategy:
      matrix:
        app: [tenant-management-webapp, status-app]
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2
        with:
          node-version: "12"
      - uses: actions/cache@v2
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
      - name: E2E Test
        uses: ./.github/actions/nx-cypress-e2e
        with:
          app: ${{ matrix.app }}
          environment: test
          tags: "@regression and not @ignore"
          core-api-client-secret: ${{ secrets.CY_CORE_API_CLIENT_SECRET }}
          core-api-user-password: ${{ secrets.CY_CORE_API_USER_PASSWORD }}
          api-client-secret: ${{ secrets.CY_CLIENT_SECRET }}
          cy-password: ${{ secrets.CY_PASSWORD }}
          cy-password-2: ${{ secrets.CY_PASSWORD2 }}
          cy-password-3: ${{ secrets.CY_PASSWORD3 }}

  deployStaging:
    runs-on: ubuntu-20.04
    needs: testRegression
    env:
      AFFECTED_APPS: ${{ github.event.inputs.APPs }}
    environment:
      name: Staging
    steps:
      - name: Oc login
        uses: redhat-actions/oc-login@v1
        with:
          openshift_server_url: ${{ secrets.OPENSHIFT_SERVER }}
          openshift_token: ${{ secrets.OPENSHIFT_TOKEN }}
          namespace: core-services-infra
          insecure_skip_tls_verify: true
      - name: Tag UAT
        run: |
          for app in $AFFECTED_APPS
          do
            oc tag $app:test $app:uat --reference-policy='local'
          done
      - name: Deploy UAT
        run: |
          for app in $AFFECTED_APPS
          do
            oc project core-services-uat
            oc rollout latest dc/$app
            oc rollout status dc/$app
          done
